FROM alpine:3.19

# Install runtime dependencies
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    bash

# Create temporal user and group
RUN addgroup -g 1000 temporal && \
    adduser -u 1000 -G temporal -s /bin/sh -D temporal

# Create necessary directories
RUN mkdir -p /app && \
    chown -R temporal:temporal /app

# Copy UI server binary (available after running download-binaries.sh)
COPY binaries/ui-server /usr/local/bin/ui-server

# Set permissions
RUN chmod +x /usr/local/bin/ui-server

# Switch to temporal user
USER temporal

# Expose UI server port
EXPOSE 8080

# Set working directory
WORKDIR /app

# Environment variables (can be overridden in docker-compose or k8s)
ENV TEMPORAL_ADDRESS=temporal:7233
ENV TEMPORAL_UI_PORT=8080
ENV TEMPORAL_CORS_ORIGINS=http://localhost:3000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1

# Default command
CMD ["ui-server", "start"]
